name: Deploy
permissions:
  contents: read

# Triggered when tags starting with 'v' are pushed
on:
  push:
    tags:
      - "v*"

env:
  TAG_NAME: ${{ github.ref_name }}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        uses: docker/bake-action@v6
        env:
          VERSION: ${{ env.TAG_NAME }}
          OPENCV_VERSION: 4.12.0
          BUILDX_BAKE_GIT_AUTH_TOKEN: ${{ secrets.ASSETS_PAT }}
        with:
          load: true
          pull: true

      - name: Export Docker images
        run: |
          set -euo pipefail
          docker image save \
            mehrak:latest \
            mehrak-dashboard:latest \
            mehrak-application:latest \
            -o mehrak-images.tar

      - name: Save Docker images as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mehrak-images
          path: mehrak-images.tar

      # - name: Upload image archive to server
      #   uses: appleboy/scp-action@v0.1.7
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: ${{ secrets.SSH_PORT || '22' }}
      #     source: mehrak-images.tar
      #     target: /tmp

      # - name: Deploy to server
      #   uses: appleboy/ssh-action@v1
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     port: ${{ secrets.SSH_PORT || '22' }}
      #     script: |
      #       set -euo pipefail
      #       docker load -i /tmp/mehrak-images.tar
      #       rm -f /tmp/mehrak-images.tar
      #       docker compose up -d --remove-orphans --no-build
      #       docker image prune -af --filter "until=24h"

  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-24.04
    needs: deploy

    concurrency:
      group: dashboard-production-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ASSETS_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: Dashboard/package-lock.json

      - name: Install dependencies (Node.js)
        working-directory: ./Dashboard
        run: npm ci

      - name: Build dashboard
        working-directory: ./Dashboard
        env:
          VITE_APP_BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: npm run build

      - name: Deploy Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./Dashboard
          command: pages deploy ./dist/ --project-name mehrak-site --branch mehrak-site-prod
